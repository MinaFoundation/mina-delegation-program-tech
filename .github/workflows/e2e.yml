name: E2E Test Mina Delegation Program

on:
  workflow_dispatch:
    inputs:
      mina_daemon_image:
        description: 'MINA_DAEMON_IMAGE'
        required: true
        default: 'gcr.io/o1labs-192920/mina-daemon:2.0.0berkeley-rc1-1551e2f-bullseye-berkeley'
      uptime_service_image:
        description: 'UPTIME_SERVICE_IMAGE'
        required: true
        default: '673156464838.dkr.ecr.us-west-2.amazonaws.com/uptime-service-backend:2.0.0rc7-5fba917'
      coordinator_branch:
        description: 'COORDINATOR_BRANCH'
        required: true
        default: '2.0.0rc2'
      stateless_verifier_image:
        description: 'STATELESS_VERIFIER_IMAGE'
        required: true
        default: '673156464838.dkr.ecr.us-west-2.amazonaws.com/delegation-verify:2.0.0rc2-delegation_verify_over_stdin_rc_base-230f610'
      no_checks:
          description: 'env NO_CHECKS, set to 1 to run stateless verification with --no-checks'
          required: true
          default: '0'

env:
  MINA_DAEMON_IMAGE: ${{ github.event.inputs.mina_daemon_image }}
  NO_CHECKS: ${{ github.event.inputs.no_checks }}
  UPTIME_SERVICE_IMAGE: ${{ github.event.inputs.uptime_service_image }}
  COORDINATOR_BRANCH: ${{ github.event.inputs.coordinator_branch }}
  STATELESS_VERIFIER_IMAGE: ${{ github.event.inputs.stateless_verifier_image }}
  E2E_SECRET: ${{ secrets.E2E_SECRET }}
  AWS_ROLE_ARN: ''

jobs:
  build:
    runs-on: minafoundation-xlarge-runners
  
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4    

    - name: 🔑 ECR Login
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: 🤌 Get Minimina
      uses: MinaFoundation/install-minimina-action@v1
      with:
        stream: stable
        
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10.12

    - name: ⚙️ Install dependencies
      run: |
        pip install poetry
        poetry install
    
    - name: 🛠️ E2E Test Setup
      run: poetry run invoke test setup

    - name: 🔁 E2E Test Start
      run: poetry run invoke test start
    
    - name: ⏳ Wait for verifications
      run: poetry run invoke test wait
    
    - name: 🛑 E2E Test Stop & Dump Logs
      if: always()
      run: |
        poetry run invoke test stop
        poetry run invoke test dump-logs
    
    - name: 🧪 E2E Test Run Checks
      run: poetry run invoke test assert

    - name: 📎 Upload logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: logs
        path: runtime/logs
    
    - name: 🔨 E2E Test Teardown
      if: success()
      run: poetry run invoke test teardown